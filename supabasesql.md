-- 1. ADIM: Varsa eski tabloları temizle (Sıfırdan kurulum için)
DROP TABLE IF EXISTS public.sinav_log;
DROP TABLE IF EXISTS public.sistem_loglari;

-- 2. ADIM: Sınav Sonuçları Tablosunu Oluştur (sinav_log)
CREATE TABLE public.sinav_log (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    
    -- Kullanıcı Bilgileri
    adi text,
    email text,
    sinifi integer,
    
    -- Lokasyon Bilgileri (Yeni)
    il text,
    ilce text,
    okul text,

    -- KVKK ve Yasal Onay (Yeni)
    kvkk_onayi boolean default false,
    kvkk_onay_tarihi text,

    -- Sınav ve Puan Bilgileri
    puan integer,
    tarih timestamp with time zone,
    
    -- Detaylı JSON Veriler
    cihaz jsonb,            -- IP, Tarayıcı vb.
    cozdugu_sinav jsonb,    -- Hangi sınav olduğu
    sonuclar jsonb,         -- Yapay zeka dönütleri
    token_kullanimi jsonb   -- (Yeni) Prompt/Response token sayıları
);

-- 3. ADIM: Sistem Aktivite Logları Tablosunu Oluştur (sistem_loglari)
CREATE TABLE public.sistem_loglari (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    
    email text,
    islem text,  -- LOGIN, LOGOUT, EXAM_START vb.
    detay text,
    cihaz jsonb
);

-- 4. ADIM: Güvenlik Ayarları (Row Level Security - RLS)

-- Tablolarda RLS'i etkinleştir (Varsayılan olarak her şeyi kilitler)
ALTER TABLE public.sinav_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sistem_loglari ENABLE ROW LEVEL SECURITY;

-- 5. ADIM: Erişim Politikaları (Policies)
-- Amaç: Anonim kullanıcılar (siteden gelenler) SADECE veri ekleyebilsin.
-- Veri okuma, silme veya güncelleme yapamasınlar.

-- sinav_log için sadece INSERT izni
CREATE POLICY "Sadece veri girişine izin ver"
ON public.sinav_log
FOR INSERT
TO anon, authenticated
WITH CHECK (true);

-- sistem_loglari için sadece INSERT izni
CREATE POLICY "Sadece log girişine izin ver"
ON public.sistem_loglari
FOR INSERT
TO anon, authenticated
WITH CHECK (true);

-- Not: SELECT (Okuma) politikası eklemediğimiz için, 
-- site üzerinden kimse veritabanını sorgulayamaz veya başkasının verisini göremez.
-- Verileri sadece siz Supabase panelinden görebilirsiniz.